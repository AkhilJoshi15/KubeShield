# KubeShield Fluent Bit Configuration
# Collects and forwards logs to Kafka for anomaly detection

[SERVICE]
    Daemon Off
    Flush 5
    Log_Level info
    Parsers_File parsers.conf
    HTTP_Server On
    HTTP_Listen 0.0.0.0
    HTTP_Port 2020
    Health_Check On

# Input: Kubernetes audit logs
[INPUT]
    Name tail
    Path /var/log/kubernetes/audit/audit.log
    Parser json
    Tag kube.audit
    Refresh_Interval 5
    Mem_Buf_Limit 50MB
    Skip_Long_Lines On

# Input: Kubelet logs
[INPUT]
    Name systemd
    Tag kubelet
    Path /var/log/journal
    Read_From_Tail On
    Strip_Underscores On

# Input: Container logs
[INPUT]
    Name tail
    Path /var/log/containers/*.log
    Parser docker
    Tag container.*
    Refresh_Interval 5
    Mem_Buf_Limit 50MB
    Skip_Long_Lines On

# Filter: Parse JSON logs
[FILTER]
    Name parser
    Match kube.audit
    Key_Name log
    Parser json
    Preserve_Key On

# Filter: Extract metadata
[FILTER]
    Name kubernetes
    Match container.*
    Kube_URL https://kubernetes.default.svc:443
    Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
    Merge_Log On
    Keep_Log Off

# Filter: Add hostname
[FILTER]
    Name modify
    Match *
    Add hostname ${HOSTNAME}
    Add timestamp ${TIMESTAMP}

# Output: Send to Kafka (kubeshield-telemetry topic)
[OUTPUT]
    Name kafka
    Match kube.audit
    Brokers kafka-broker:9092
    Topics kubeshield-telemetry
    Timestamp_Key timestamp
    Timestamp_Format iso8601
    Key_From_Headers tenant
    Retry_Backoff 300

[OUTPUT]
    Name kafka
    Match kubelet
    Brokers kafka-broker:9092
    Topics kubeshield-telemetry
    Timestamp_Key timestamp
    Timestamp_Format iso8601
    Retry_Backoff 300

[OUTPUT]
    Name kafka
    Match container.*
    Brokers kafka-broker:9092
    Topics kubeshield-telemetry
    Timestamp_Key timestamp
    Timestamp_Format iso8601
    Retry_Backoff 300

# Monitoring metrics
[OUTPUT]
    Name prometheus_exporter
    Match internal_metrics
    Host 0.0.0.0
    Port 2021
